# ğŸ“¦ NGINX Mirror + K6 ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸

## ğŸ“‹ í”„ë¡œì íŠ¸ ì†Œê°œ

ì´ í”„ë¡œì íŠ¸ëŠ” NGINXë¥¼ ì‚¬ìš©í•˜ì—¬ **íŠ¸ë˜í”½ ë¯¸ëŸ¬ë§(Traffic Mirroring)** ê¸°ëŠ¥ì„ êµ¬í˜„í•œ ì˜ˆì œì…ë‹ˆë‹¤. ì£¼ìš” ëª©ì ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  HTTP ìš”ì²­ì„ **Server A**ë¡œ ë¼ìš°íŒ…
2. ë™ì¼í•œ ìš”ì²­ì„ **Server B**ë¡œ ë³µì œ(mirror)
3. í´ë¼ì´ì–¸íŠ¸ëŠ” **Server A**ì˜ ì‘ë‹µë§Œ ë°›ìŒ
4. **K6**ë¥¼ ì‚¬ìš©í•œ ê°„ë‹¨í•œ ë¶€í•˜ í…ŒìŠ¤íŠ¸ í¬í•¨

### âœ¨ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

- **A/B í…ŒìŠ¤íŠ¸**: ë‘ ë²„ì „ì˜ API ì„±ëŠ¥ ë¹„êµ
- **Shadow í…ŒìŠ¤íŠ¸**: ì‹¤ì œ íŠ¸ë˜í”½ìœ¼ë¡œ ìƒˆ ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸
- **ë¡œê·¸/ë¶„ì„**: ì‹¤ì œ ìš”ì²­ì„ ë¶„ì„ ì‹œìŠ¤í…œìœ¼ë¡œ ë³µì œ
- **ì¥ì•  ê°ì§€**: ê°™ì€ ìš”ì²­ì— ëŒ€í•œ ë‘ ì‹œìŠ¤í…œì˜ ì‘ë‹µ ë¹„êµ

### â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)

### "nginxì—ì„œ ì‹¤ì‹œê°„ íŠ¸ë˜í”½ì„ ë³µì œí•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?"

NGINXì—ì„œ ì‹¤ì‹œê°„ íŠ¸ë˜í”½ì„ ë³µì œí•˜ëŠ” ê¸°ë³¸ ë°©ë²•ì€ `mirror` ì§€ì‹œì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. 
```nginx
location /api/ {
    mirror /mirror/;
    proxy_pass http://main-server:3000;
}

location = /mirror/ {
    internal;
    proxy_pass http://mirror-server:3000;
}
```
ì´ ì„¤ì •ìœ¼ë¡œ `/api/`ë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ìš”ì²­ì´ main-serverë¡œ ì „ë‹¬ë˜ë©´ì„œ ë™ì‹œì— mirror-serverë¡œë„ ë³µì œë©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” main-serverì˜ ì‘ë‹µë§Œ ë°›ìŠµë‹ˆë‹¤.

### "nginxë¡œ ìš”ì²­ì„ ë‹¤ë¥¸ ì„œë²„ë¡œ ë³µì‚¬í•˜ëŠ” ë°©ë²•ì´ ìˆë‚˜ìš”?"

ë„¤, NGINXì˜ `mirror` ëª¨ë“ˆì„ ì‚¬ìš©í•˜ë©´ ìš”ì²­ì„ ë‹¤ë¥¸ ì„œë²„ë¡œ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```nginx
server {
    listen 80;
    
    location / {
        mirror /mirror;
        proxy_pass http://primary-server;
    }
    
    location = /mirror {
        internal;
        proxy_pass http://secondary-server;
        proxy_set_header X-Original-URI $request_uri;
    }
}
```
ì›ë³¸ ìš”ì²­ URIë¥¼ ì¶”ì í•˜ê³  ì‹¶ë‹¤ë©´ `X-Original-URI` ê°™ì€ ì»¤ìŠ¤í…€ í—¤ë”ë¥¼ í†µí•´ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### "nginxì—ì„œ ë‹¤í¬ ì¹´ë‚˜ë¦¬ì•„ ì „ëµì„ êµ¬í˜„í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?"

ë‹¤í¬ ì¹´ë‚˜ë¦¬ì•„(Dark Canary) ë°°í¬ ì „ëµì€ ì‹¤ì œ íŠ¸ë˜í”½ì˜ ë³µì‚¬ë³¸ì„ ìƒˆ ë²„ì „ìœ¼ë¡œ ë³´ë‚´ì„œ ìœ„í—˜ ì—†ì´ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤:

```nginx
server {
    listen 80;
    
    # ëª¨ë“  ìš”ì²­ì€ ê¸°ì¡´ ë²„ì „ìœ¼ë¡œ ì „ë‹¬
    location / {
        proxy_pass http://stable-version;
        
        # 10%ì˜ íŠ¸ë˜í”½ì„ ìƒˆ ë²„ì „ìœ¼ë¡œ ë¯¸ëŸ¬ë§ (ë‹¤í¬ ì¹´ë‚˜ë¦¬ì•„)
        if ($request_id ~ "^.{0}[0-9].*$") {
            mirror /canary;
        }
    }
    
    # ì¹´ë‚˜ë¦¬ì•„ ë‚´ë¶€ ë¼ìš°íŒ…
    location = /canary {
        internal;
        proxy_pass http://new-version;
        proxy_set_header X-Canary-Request "true";
    }
}
```

ì´ë ‡ê²Œ ì„¤ì •í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” í•­ìƒ ì•ˆì • ë²„ì „ì—ì„œ ì‘ë‹µì„ ë°›ì§€ë§Œ, ì•½ 10%ì˜ ìš”ì²­ì´ ìƒˆ ë²„ì „ìœ¼ë¡œë„ ë™ì‹œì— ì „ì†¡ë˜ì–´ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### "nginxë¥¼ ì‚¬ìš©í•œ A/B í…ŒìŠ¤íŠ¸ ì„¤ì • ë°©ë²•ì€?"

NGINXì—ì„œ A/B í…ŒìŠ¤íŠ¸ë¥¼ ì„¤ì •í•˜ëŠ” ë°©ë²•ì€ ë‘ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤:

1. **íŠ¸ë˜í”½ ë¶„í• **: ì¼ë¶€ ì‚¬ìš©ìëŠ” A ë²„ì „, ë‚˜ë¨¸ì§€ëŠ” B ë²„ì „ìœ¼ë¡œ ë¼ìš°íŒ…
```nginx
split_clients "${remote_addr}${http_user_agent}" $variant {
    50%     "a";
    *       "b";
}

server {
    listen 80;
    
    location / {
        proxy_pass http://version_${variant};
    }
}

upstream version_a {
    server server_a:3000;
}

upstream version_b {
    server server_b:3000;
}
```

2. **ë¯¸ëŸ¬ë§ ë°©ì‹**: ëª¨ë“  ì‚¬ìš©ìëŠ” A ë²„ì „ ì‘ë‹µì„ ë°›ê³ , B ë²„ì „ìœ¼ë¡œë„ ìš”ì²­ ë³µì œ
```nginx
server {
    listen 80;
    
    location / {
        mirror /versionB;
        proxy_pass http://version_a;
    }
    
    location = /versionB {
        internal;
        proxy_pass http://version_b;
    }
}
```

ë‘ ë²ˆì§¸ ë°©ì‹ì€ ì‹¤ì œ A/B í…ŒìŠ¤íŠ¸ë³´ë‹¤ëŠ” 'ì„€ë„ìš° í…ŒìŠ¤íŠ¸'ì— ê°€ê¹ìŠµë‹ˆë‹¤.

### "nginxì—ì„œ íŠ¸ë˜í”½ ë¦¬í”Œë¦¬ì¼€ì´ì…˜ì„ ì„¤ì •í•˜ëŠ” ë°©ë²•ì€?"

íŠ¸ë˜í”½ ë¦¬í”Œë¦¬ì¼€ì´ì…˜ì€ mirror ëª¨ë“ˆì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•©ë‹ˆë‹¤:

```nginx
server {
    listen 80;
    
    # ê¸°ë³¸ ìœ„ì¹˜ ë¸”ë¡
    location / {
        proxy_pass http://primary_server;
        
        # ëª¨ë“  ìš”ì²­ì„ ë³µì œ
        mirror /replica;
    }
    
    # ë³µì œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë‚´ë¶€ ìœ„ì¹˜
    location = /replica {
        internal;
        proxy_pass http://replica_server;
        
        # ë³µì œëœ ìš”ì²­ì„ì„ ì•Œë¦¬ëŠ” í—¤ë” ì¶”ê°€
        proxy_set_header X-Replicated-Request "true";
        
        # ì›ë³¸ ìš”ì²­ ì •ë³´ ìœ ì§€
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

ë³µì œëœ íŠ¸ë˜í”½ì„ ì‹ë³„í•˜ê¸° ìœ„í•´ `X-Replicated-Request` ê°™ì€ ì»¤ìŠ¤í…€ í—¤ë”ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### "nginxë¡œ ìš”ì²­ì„ ë³µì œí•˜ì—¬ ë¡œê¹… ì„œë²„ë¡œ ë³´ë‚´ëŠ” ë°©ë²•ì´ ìˆë‚˜ìš”?"

NGINXì—ì„œ ìš”ì²­ì„ ë¡œê¹… ì„œë²„ë¡œ ë³µì œí•˜ëŠ” ì„¤ì •ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

```nginx
server {
    listen 80;
    
    location / {
        # ì›ë³¸ ìš”ì²­ ì²˜ë¦¬
        proxy_pass http://application_server;
        
        # ë¡œê¹… ëª©ì ìœ¼ë¡œ ìš”ì²­ ë³µì œ
        mirror /logging;
    }
    
    location = /logging {
        internal;
        
        # ë¡œê¹… ì„œë²„ë¡œ ì „ë‹¬
        proxy_pass http://logging_server;
        
        # ë¡œê¹…ì— í•„ìš”í•œ ì¶”ê°€ ì •ë³´ ì „ë‹¬
        proxy_set_header X-Request-Time $request_time;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Host $host;
        proxy_set_header X-Client-IP $remote_addr;
        
        # ìš”ì²­ ë³¸ë¬¸ í¬í•¨
        proxy_pass_request_body on;
    }
}
```

ì´ êµ¬ì„±ì„ í†µí•´ ëª¨ë“  ìš”ì²­ì˜ ìƒì„¸ ì •ë³´ê°€ ë¡œê¹… ì„œë²„ë¡œ ì „ì†¡ë˜ë©°, ì›ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‘ë‹µ ì‹œê°„ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## ğŸ” ì‘ë™ ë°©ì‹

![NGINX ë¯¸ëŸ¬ë§ ë‹¤ì´ì–´ê·¸ë¨](https://your-image-url-here.com/nginx-mirror-diagram.png)
(ë¸”ë¡œê·¸ ì‘ì„± ì‹œ ë‹¤ì´ì–´ê·¸ë¨ ì´ë¯¸ì§€ ì¶”ê°€ ê¶Œì¥)

1. í´ë¼ì´ì–¸íŠ¸ê°€ `http://localhost:8080/api/...` ë¡œ ìš”ì²­ ì „ì†¡
2. NGINXê°€ ìš”ì²­ì„ ìˆ˜ì‹ í•˜ê³  **ë‘ ê°€ì§€ ì‘ì—…**ì„ ìˆ˜í–‰:
   - ìš”ì²­ì„ **Server A**ë¡œ ì „ë‹¬ (í”„ë¡ì‹œ)
   - ë™ì¼í•œ ìš”ì²­ì„ **Server B**ë¡œ ë¯¸ëŸ¬ë§ (ë‚´ë¶€ì ìœ¼ë¡œ ë³µì œ)
3. **Server A**ëŠ” ì‘ë‹µ ìƒì„± â†’ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬
4. **Server B**ëŠ” ìš”ì²­ ì²˜ë¦¬ í›„ ì‘ë‹µ ìƒì„± â†’ ì‘ë‹µì€ ë²„ë ¤ì§(discard)
5. í´ë¼ì´ì–¸íŠ¸ëŠ” ì˜¤ì§ **Server A**ì˜ ì‘ë‹µë§Œ ìˆ˜ì‹ 

---

## ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
nginx-mirror-test/
â”œâ”€â”€ docker-compose.yml         # Docker ì»¨í…Œì´ë„ˆ êµ¬ì„±
â”œâ”€â”€ nginx/
â”‚   â””â”€â”€ default.conf           # NGINX ì„¤ì • (ë¯¸ëŸ¬ë§ ì„¤ì • í¬í•¨)
â”œâ”€â”€ server-a/
â”‚   â”œâ”€â”€ app.js                 # Express ì„œë²„ (ë©”ì¸)
â”‚   â”œâ”€â”€ package.json           # ì˜ì¡´ì„± ì •ì˜
â”‚   â””â”€â”€ Dockerfile             # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì„¤ì •
â”œâ”€â”€ server-b/
â”‚   â”œâ”€â”€ app.js                 # Express ì„œë²„ (ë¯¸ëŸ¬)
â”‚   â”œâ”€â”€ package.json           # ì˜ì¡´ì„± ì •ì˜
â”‚   â””â”€â”€ Dockerfile             # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì„¤ì •
â”œâ”€â”€ k6/
â”‚   â””â”€â”€ test-script.js         # ë¶€í•˜ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ README.md                  # ì´ ë¬¸ì„œ
```

---

## âš™ï¸ ì„œë¹„ìŠ¤ êµ¬ì„± ë° í¬íŠ¸

| ì„œë¹„ìŠ¤ ì´ë¦„ | ì„¤ëª…                    | ë‚´ë¶€ í¬íŠ¸ | ë¡œì»¬ í¬íŠ¸ | ì ‘ê·¼ URL                |
|-------------|-------------------------|-----------|-----------|--------------------------|
| NGINX       | ìš”ì²­ ìˆ˜ì‹  ë° ë¯¸ëŸ¬ ì²˜ë¦¬ | 80        | **8080**  | http://localhost:8080/api/... |
| Server A    | ë©”ì¸ ì²˜ë¦¬ ì„œë²„         | 3000      | **3001**  | http://localhost:3001/... (ì§ì ‘ ì ‘ê·¼ìš©) |
| Server B    | ë¯¸ëŸ¬ë§ìš© ì„œë²„          | 3000      | **3002**  | http://localhost:3002/... (ì§ì ‘ ì ‘ê·¼ìš©) |
| K6          | ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ë„êµ¬   | -         | -         | - |

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### ì¤€ë¹„ ì‚¬í•­
- [Docker](https://www.docker.com/get-started) ì„¤ì¹˜
- [Docker Compose](https://docs.docker.com/compose/install/) ì„¤ì¹˜

### ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ì´ë“œ

1. **í”„ë¡œì íŠ¸ í´ë¡  ë˜ëŠ” íŒŒì¼ ìƒì„±**

```bash
git clone https://github.com/your-username/nginx-mirror-test.git
# ë˜ëŠ”
mkdir nginx-mirror-test && cd nginx-mirror-test
```

2. **íŒŒì¼ êµ¬ì¡° ìƒì„±**  
   ìœ„ ë””ë ‰í† ë¦¬ êµ¬ì¡°ì— ë§ê²Œ íŒŒì¼ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤. ê° íŒŒì¼ì˜ ë‚´ìš©ì€ ì•„ë˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

3. **Docker Compose ì‹¤í–‰**

```bash
docker-compose build --no-cache  # ì²˜ìŒ ì‹¤í–‰ ì‹œ --no-cache ì˜µì…˜ ì¶”ì²œ
docker-compose up                # ì„œë¹„ìŠ¤ ì‹¤í–‰
```

4. **í…ŒìŠ¤íŠ¸ ìš”ì²­ ë³´ë‚´ê¸°**

```bash
curl http://localhost:8080/api/test
```

5. **ê²°ê³¼ í™•ì¸**
   - í„°ë¯¸ë„ì—ì„œ `docker-compose up` ì¶œë ¥ì„ ë³´ë©´ ë‘ ì„œë²„ ëª¨ë‘ ìš”ì²­ì„ ë°›ì•˜ëŠ”ì§€ í™•ì¸
   - **Server A** ë¡œê·¸: `Server A received: GET /api/test`
   - **Server B** ë¡œê·¸: `Server B (mirror) received: GET /api/test`
   - í´ë¼ì´ì–¸íŠ¸ëŠ” `Handled by Server A` ì‘ë‹µë§Œ ë°›ìŒ

6. **ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìë™ ì‹¤í–‰ë¨)**  
   `docker-compose up` ì‹¤í–‰ ì‹œ k6 ì»¨í…Œì´ë„ˆê°€ ìë™ìœ¼ë¡œ 10ì´ˆê°„ ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

7. **ì¢…ë£Œ**

```bash
docker-compose down  # ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ì»¨í…Œì´ë„ˆ ì œê±°
```

---

## ğŸ“Š ë¡œê·¸ í™•ì¸ ë°©ë²•

Dockerì—ì„œ ì»¨í…Œì´ë„ˆ ë¡œê·¸ë¥¼ í™•ì¸í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í†µí•´ ë¯¸ëŸ¬ë§ ì‘ë™ ë° ìš”ì²­/ì‘ë‹µì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 1. Docker Desktop UIì—ì„œ ë¡œê·¸ ë³´ê¸°

1. Docker Desktop ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
2. **Containers** íƒ­ìœ¼ë¡œ ì´ë™
3. ì»¨í…Œì´ë„ˆ ì´ë¦„ ì˜†ì˜ ë¡œê·¸ ì•„ì´ì½˜(ğŸ“‹) í´ë¦­
4. ë¡œê·¸ ì°½ì—ì„œ ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸ ê°€ëŠ¥

### 2. í„°ë¯¸ë„ì—ì„œ ë¡œê·¸ ë³´ê¸° (ê¶Œì¥)

```bash
# ëª¨ë“  ì»¨í…Œì´ë„ˆì˜ ë¡œê·¸ í™•ì¸
docker-compose logs

# íŠ¹ì • ì„œë¹„ìŠ¤ì˜ ë¡œê·¸ë§Œ í™•ì¸
docker-compose logs nginx
docker-compose logs server_a
docker-compose logs server_b

# ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸ (follow ì˜µì…˜)
docker-compose logs -f

# íŠ¹ì • ì„œë¹„ìŠ¤ì˜ ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
docker-compose logs -f server_a
```

### 3. ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥

```bash
# ëª¨ë“  ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥
docker-compose logs > logs.txt

# íŠ¹ì • ì„œë¹„ìŠ¤ ë¡œê·¸ë§Œ íŒŒì¼ë¡œ ì €ì¥
docker-compose logs server_a > server_a_logs.txt
```

### 4. docker-compose.ymlì— ë¡œê¹… ì„¤ì • ì¶”ê°€

ë¡œê·¸ ê´€ë¦¬ë¥¼ ìœ„í•´ docker-compose.yml íŒŒì¼ì˜ ê° ì„œë¹„ìŠ¤ì— ë¡œê¹… ì„¤ì •ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```yaml
services:
  server_a:
    # ê¸°ì¡´ ì„¤ì •...
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

ì´ ì„¤ì •ì€ ë¡œê·¸ íŒŒì¼ í¬ê¸°ë¥¼ ì œí•œí•˜ê³  ë¡œí…Œì´ì…˜ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

### 5. ë¡œê·¸ í™•ì¸ ë„êµ¬ í™œìš©

- **Portainer**: Docker ê´€ë¦¬ UIë¡œ, ì»¨í…Œì´ë„ˆ ë¡œê·¸ë¥¼ ë³´ê¸° ì‰½ê²Œ í•´ì¤ë‹ˆë‹¤.
- **Dozzle**: ì›¹ ê¸°ë°˜ì˜ ê°€ë²¼ìš´ Docker ë¡œê·¸ ë·°ì–´ (https://github.com/amir20/dozzle)

```bash
# Dozzle ì‹¤í–‰ ì˜ˆì‹œ
docker run --name dozzle -d --volume=/var/run/docker.sock:/var/run/docker.sock -p 8888:8080 amir20/dozzle
```

ì‹¤í–‰ í›„ `http://localhost:8888`ìœ¼ë¡œ ì ‘ì†í•˜ì—¬ ëª¨ë“  ì»¨í…Œì´ë„ˆì˜ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“œ ì£¼ìš” íŒŒì¼ ì„¤ëª…

### ğŸ“„ docker-compose.yml

```yaml
version: '3.8'
services:
  nginx:
    image: nginx:latest
    ports:
      - "8080:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - server_a
      - server_b
  server_a:
    build: ./server-a
    ports:
      - "3001:3000"
    volumes:
      - ./server-a:/usr/src/app
      - /usr/src/app/node_modules  # node_modulesë¥¼ ë³´ì¡´í•˜ê¸° ìœ„í•œ ìµëª… ë³¼ë¥¨
    working_dir: /usr/src/app
    command: node app.js
  server_b:
    build: ./server-b
    ports:
      - "3002:3000"
    volumes:
      - ./server-b:/usr/src/app
      - /usr/src/app/node_modules  # node_modulesë¥¼ ë³´ì¡´í•˜ê¸° ìœ„í•œ ìµëª… ë³¼ë¥¨
    working_dir: /usr/src/app
    command: node app.js
  k6:
    image: grafana/k6
    volumes:
      - ./k6:/scripts
    entrypoint: ["k6", "run", "/scripts/test-script.js"]
    depends_on:
      - nginx
```

#### ë³¼ë¥¨ ì„¤ì • ì¤‘ìš” í¬ì¸íŠ¸
- `/usr/src/app/node_modules` ìµëª… ë³¼ë¥¨ì€ ì»¨í…Œì´ë„ˆì˜ node_modules ë””ë ‰í† ë¦¬ë¥¼ ë³´ì¡´í•©ë‹ˆë‹¤
- ë¡œì»¬ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ê°€ ì»¨í…Œì´ë„ˆì˜ node_modulesë¥¼ ê°€ë¦¬ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤
- ì´ë ‡ê²Œ í•˜ë©´ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì„¤ì¹˜ëœ npm ëª¨ë“ˆì— ì •ìƒì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

### ğŸ“„ nginx/default.conf

```nginx
server {
    listen 80;

    location /api/ {
        mirror /mirror/;
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

#### NGINX ì„¤ì • ì„¤ëª…
- `mirror /mirror/;` - ì›ë³¸ ìš”ì²­ì„ `/mirror/` ìœ„ì¹˜ë¡œ ë³µì œ
- `internal;` - ì™¸ë¶€ì—ì„œ ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” ë‚´ë¶€ ìœ„ì¹˜ë¡œ ì§€ì •
- `proxy_pass http://server_X:3000;` - Dockerì˜ ì„œë¹„ìŠ¤ëª…ì„ ê·¸ëŒ€ë¡œ hostnameìœ¼ë¡œ ì‚¬ìš©

### ğŸ“„ server-a/app.js

```javascript
const express = require('express');
const app = express();
app.use(express.json());

app.all('*', (req, res) => {
  console.log('Server A received:', req.method, req.url);
  res.send('Handled by Server A');
});

app.listen(3000, () => console.log('Server A running on port 3000'));
```

### ğŸ“„ server-b/app.js

```javascript
const express = require('express');
const app = express();
app.use(express.json());

app.all('*', (req, res) => {
  console.log('Server B (mirror) received:', req.method, req.url);
  res.sendStatus(204);  // No Content ì‘ë‹µ (ë¯¸ëŸ¬ë§ì´ë¯€ë¡œ ì‘ë‹µ ë‚´ìš©ì€ ì¤‘ìš”í•˜ì§€ ì•ŠìŒ)
});

app.listen(3000, () => console.log('Server B running on port 3000'));
```

### ğŸ“„ server-a/Dockerfile & server-b/Dockerfile

```dockerfile
FROM node:18
WORKDIR /usr/src/app
COPY package*.json ./
RUN npm install
COPY . .
CMD ["node", "app.js"]
```

#### Dockerfile ì„¤ëª…
- `COPY package*.json ./` - ì˜ì¡´ì„± ì •ì˜ íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (ìºì‹± ìµœì í™”)
- `RUN npm install` - ì˜ì¡´ì„± ì„¤ì¹˜
- `COPY . .` - ë‚˜ë¨¸ì§€ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬

### ğŸ“„ server-a/package.json & server-b/package.json

```json
{
  "name": "server-a",
  "version": "1.0.0",
  "main": "app.js",
  "license": "MIT",
  "dependencies": {
    "express": "^4.18.2"
  }
}
```

### ğŸ“„ k6/test-script.js

```javascript
import http from 'k6/http';
import { sleep } from 'k6';

export let options = {
  vus: 10,           // ê°€ìƒ ì‚¬ìš©ì ìˆ˜ (ë™ì‹œ ì—°ê²°)
  duration: '10s',   // í…ŒìŠ¤íŠ¸ ì‹œê°„
};

export default function () {
  http.get('http://nginx/api/test');
  sleep(1);  // 1ì´ˆ ëŒ€ê¸°
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²• ë° í™œìš© ì˜ˆì‹œ

### ê¸°ë³¸ í…ŒìŠ¤íŠ¸

```bash
# ë‹¨ì¼ ìš”ì²­ í…ŒìŠ¤íŠ¸
curl http://localhost:8080/api/test

# POST ìš”ì²­ í…ŒìŠ¤íŠ¸
curl -X POST -H "Content-Type: application/json" \
     -d '{"data":"test"}' \
     http://localhost:8080/api/users
```

### ê³ ê¸‰ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### 1. ë‹¤ì–‘í•œ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
server-aì™€ server-bì˜ app.jsë¥¼ ìˆ˜ì •í•˜ì—¬ ì—¬ëŸ¬ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```javascript
// express ë¼ìš°í„° ì„¤ì • ì˜ˆì‹œ
app.get('/api/users', (req, res) => {
  console.log('GET /api/users received');
  res.json({ users: ['user1', 'user2'] });
});

app.post('/api/users', (req, res) => {
  console.log('POST /api/users received', req.body);
  res.status(201).json({ success: true, data: req.body });
});
```

#### 2. ì„±ëŠ¥ ì°¨ì´ ëª¨ë‹ˆí„°ë§
ì„œë²„ Aì™€ ì„œë²„ Bì— íƒ€ì´ë° ë¡œê·¸ë¥¼ ì¶”ê°€í•˜ì—¬ ì„±ëŠ¥ ì°¨ì´ í™•ì¸:

```javascript
app.all('*', (req, res) => {
  const start = Date.now();
  // ë³µì¡í•œ ë¡œì§ ë˜ëŠ” DB ì—°ì‚° ì²˜ë¦¬
  const elapsed = Date.now() - start;
  console.log(`Request processed in ${elapsed}ms`);
  res.send('...');
});
```

#### 3. ë§ì¶¤í˜• K6 í…ŒìŠ¤íŠ¸ ì‘ì„±
k6/test-script.jsë¥¼ ìˆ˜ì •í•˜ì—¬ ë” ë³µì¡í•œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±:

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '20s', target: 10 },  // 10ëª…ì˜ ì‚¬ìš©ìê¹Œì§€ 20ì´ˆì— ê±¸ì³ ì¦ê°€
    { duration: '30s', target: 10 },  // 30ì´ˆ ë™ì•ˆ 10ëª… ìœ ì§€
    { duration: '10s', target: 0 },   // 10ì´ˆì— ê±¸ì³ 0ëª…ìœ¼ë¡œ ê°ì†Œ
  ],
};

export default function () {
  const res = http.get('http://nginx/api/test');
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
  sleep(1);
}
```

### 2. ê³ ê¸‰ NGINX ì„¤ì •
- SSL/TLS ì ìš©
- ìš”ì²­ ë‚´ìš© ê¸°ë°˜ìœ¼ë¡œ ë¯¸ëŸ¬ë§ ì¡°ê±´ ì„¤ì • (íŠ¹ì • í—¤ë”, ê²½ë¡œë§Œ ë¯¸ëŸ¬ë§)
- ë¡œë“œ ë°¸ëŸ°ì‹± ì¶”ê°€

```nginx
# ì¡°ê±´ë¶€ ë¯¸ëŸ¬ë§ ì˜ˆì‹œ
location /api/ {
    if ($http_x_mirror = "true") {
        mirror /mirror/;
    }
    proxy_pass http://server_a:3000;
}
```

#### ë‹¤ì–‘í•œ ì„œë¸Œ ê²½ë¡œ ë¯¸ëŸ¬ë§ ì˜ˆì œ

NGINXëŠ” ìœ ì—°í•œ ë¯¸ëŸ¬ë§ ì„¤ì •ì„ ì§€ì›í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” ë‹¤ì–‘í•œ ì¡°ê±´ê³¼ ê²½ë¡œì— ë”°ë¼ ë¯¸ëŸ¬ë§ì„ ìˆ˜í–‰í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.

##### 1. íŠ¹ì • ì„œë¸Œ ê²½ë¡œë§Œ ë¯¸ëŸ¬ë§

```nginx
server {
    listen 80;

    # /api/users/ ê²½ë¡œë§Œ ë¯¸ëŸ¬ë§
    location /api/users/ {
        mirror /mirror_users/;
        proxy_pass http://server_a:3000;
    }

    # /api/products/ ê²½ë¡œë§Œ ë¯¸ëŸ¬ë§
    location /api/products/ {
        mirror /mirror_products/;
        proxy_pass http://server_a:3000;
    }

    # ì¼ë°˜ API ê²½ë¡œ (ë¯¸ëŸ¬ë§ ì—†ìŒ)
    location /api/ {
        proxy_pass http://server_a:3000;
    }

    # users ë¯¸ëŸ¬ë§ì„ ìœ„í•œ ë‚´ë¶€ ìœ„ì¹˜
    location = /mirror_users/ {
        internal;
        proxy_pass http://server_b:3000;
    }

    # products ë¯¸ëŸ¬ë§ì„ ìœ„í•œ ë‚´ë¶€ ìœ„ì¹˜
    location = /mirror_products/ {
        internal;
        proxy_pass http://server_c:3000;  # ë‹¤ë¥¸ ì„œë²„ë¡œ ë¯¸ëŸ¬ë§
    }
}
```

##### 2. HTTP ë©”ì„œë“œì— ë”°ë¥¸ ë¯¸ëŸ¬ë§

```nginx
server {
    listen 80;

    location /api/ {
        # POST ìš”ì²­ë§Œ ë¯¸ëŸ¬ë§
        if ($request_method = "POST") {
            mirror /mirror/;
        }
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

##### 3. ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì— ë”°ë¥¸ ë¯¸ëŸ¬ë§

```nginx
server {
    listen 80;

    location /api/ {
        # debug=true ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œë§Œ ë¯¸ëŸ¬ë§
        if ($arg_debug = "true") {
            mirror /mirror/;
        }
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

##### 4. íŠ¹ì • í—¤ë” ê°’ì´ë‚˜ ì¿ í‚¤ì— ë”°ë¥¸ ë¯¸ëŸ¬ë§

```nginx
server {
    listen 80;

    location /api/ {
        # íŠ¹ì • ì‚¬ìš©ì ì—ì´ì „íŠ¸ë§Œ ë¯¸ëŸ¬ë§
        if ($http_user_agent ~* "PostmanRuntime") {
            mirror /mirror/;
        }
        # íŠ¹ì • ì„¸ì…˜ IDë¥¼ ê°€ì§„ ìš”ì²­ë§Œ ë¯¸ëŸ¬ë§
        if ($cookie_sessionid = "test-session") {
            mirror /mirror/;
        }
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

##### 5. ìš”ì²­ ë³¸ë¬¸ ë³€ê²½í•˜ì—¬ ë¯¸ëŸ¬ë§ (ì£¼ì˜: ì‹¤í—˜ì  ê¸°ëŠ¥)

```nginx
server {
    listen 80;

    location /api/ {
        mirror /mirror/;
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        
        # ë¯¸ëŸ¬ë§ëœ ìš”ì²­ì— ì¶”ê°€ í—¤ë” ì „ë‹¬
        proxy_set_header X-Mirrored-Request "true";
        
        # ìš”ì²­ ë³¸ë¬¸ì„ ê·¸ëŒ€ë¡œ ì „ë‹¬
        proxy_pass_request_body on;
        
        # ì›ë³¸ HTTP ë©”ì„œë“œ ìœ ì§€
        proxy_method $request_method;
        
        proxy_pass http://server_b:3000;
    }
}
```

##### 6. íŠ¸ë˜í”½ ìƒ˜í”Œë§ (ì¼ë¶€ ìš”ì²­ë§Œ ë¯¸ëŸ¬ë§)

```nginx
server {
    listen 80;
    
    # ë³€ìˆ˜ ì„¤ì •
    set $do_mirror 0;
    
    # ì•½ 10%ì˜ ìš”ì²­ë§Œ ë¯¸ëŸ¬ë§ (ì„ì˜ ìƒ˜í”Œë§)
    if ($request_id ~ "^.{0}[0-9a].*$") {
        set $do_mirror 1;
    }
    
    location /api/ {
        if ($do_mirror = 1) {
            mirror /mirror/;
        }
        proxy_pass http://server_a:3000;
    }
    
    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

ì´ëŸ¬í•œ ê³ ê¸‰ ì„¤ì •ì„ í†µí•´ ë¯¸ëŸ¬ë§ì„ íŠ¹ì • í™˜ê²½ì´ë‚˜ ìš”êµ¬ì‚¬í•­ì— ë§ê²Œ ì„¸ë°€í•˜ê²Œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì„±ëŠ¥ ì˜í–¥ì„ ê³ ë ¤í•˜ì—¬ ì ì ˆí•œ ë¯¸ëŸ¬ë§ ì „ëµì„ ì„ íƒí•˜ì„¸ìš”.

### 3. ëª¨ë‹ˆí„°ë§ ì¶”ê°€

---

## ğŸ”§ ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œì™€ í•´ê²° ë°©ë²•

### 1. Cannot find module 'express' ì—ëŸ¬

**ì¦ìƒ**: ì„œë²„ A ë˜ëŠ” ì„œë²„ Bê°€ ì‹œì‘ë˜ì§€ ì•Šê³  ì•„ë˜ ì˜¤ë¥˜ ì¶œë ¥
```
Error: Cannot find module 'express'
```

**ì›ì¸**: ì»¨í…Œì´ë„ˆì˜ node_modulesê°€ ë¡œì»¬ ë³¼ë¥¨ ë§ˆìš´íŠ¸ì— ì˜í•´ ê°€ë ¤ì§€ëŠ” ë¬¸ì œ

**í•´ê²°**:
- docker-compose.ymlì— ìµëª… ë³¼ë¥¨ ì¶”ê°€ (ì´ë¯¸ ì¶”ê°€ë¨)
```yaml
volumes:
  - ./server-a:/usr/src/app
  - /usr/src/app/node_modules  # ì´ ë¶€ë¶„ì´ ì¤‘ìš”
```
- ë˜ëŠ” ê¹¨ë—í•œ ë¹Œë“œ ì‹œë„:
```bash
docker-compose down -v
docker-compose build --no-cache
docker-compose up
```

### 2. NGINX ì—°ê²° ì˜¤ë¥˜

**ì¦ìƒ**: "host not found in upstream" ì˜¤ë¥˜

**ì›ì¸**: server_a, server_b ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ NGINXì—ì„œ ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ

**í•´ê²°**:
- ì»¨í…Œì´ë„ˆì˜ ìƒíƒœ í™•ì¸: `docker-compose ps`
- NGINX ì„œë¹„ìŠ¤ê°€ ì„œë²„ ì„œë¹„ìŠ¤ ë‹¤ìŒì— ì‹œì‘ë˜ë„ë¡ `depends_on` ì„¤ì • í™•ì¸
- Docker ë„¤íŠ¸ì›Œí¬ê°€ ì˜¬ë°”ë¥´ê²Œ êµ¬ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸: `docker network ls`

### 3. ë¡œì»¬ ì ‘ì† ì‹¤íŒ¨

**ì¦ìƒ**: "Connection refused" ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©° localhost:8080ì— ì ‘ì† ë¶ˆê°€

**ì›ì¸**: 
- Docker Desktopì´ ì •ìƒ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹˜
- í¬íŠ¸ ì¶©ëŒ

**í•´ê²°**:
- Docker Desktop ìƒíƒœ í™•ì¸ ë° ì¬ì‹œì‘
- í¬íŠ¸ê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸: `lsof -i :8080`
- í•„ìš”ì‹œ docker-compose.ymlì—ì„œ í¬íŠ¸ ë³€ê²½

---

## ğŸ“š í™•ì¥ ë° ìµœì í™” ë°©ë²•

### 1. ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ í†µí•©
- ë¯¸ëŸ¬ë§ ë¡œì§ì„ ì‹¤ì œ API ë˜ëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì— ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- DB ì—°ë™, ì¸ì¦ ì²˜ë¦¬ ë“±ì˜ ê¸°ëŠ¥ ì¶”ê°€ ê°€ëŠ¥

### 2. ê³ ê¸‰ NGINX ì„¤ì •
- SSL/TLS ì ìš©
- ìš”ì²­ ë‚´ìš© ê¸°ë°˜ìœ¼ë¡œ ë¯¸ëŸ¬ë§ ì¡°ê±´ ì„¤ì • (íŠ¹ì • í—¤ë”, ê²½ë¡œë§Œ ë¯¸ëŸ¬ë§)
- ë¡œë“œ ë°¸ëŸ°ì‹± ì¶”ê°€

```nginx
# ì¡°ê±´ë¶€ ë¯¸ëŸ¬ë§ ì˜ˆì‹œ
location /api/ {
    if ($http_x_mirror = "true") {
        mirror /mirror/;
    }
    proxy_pass http://server_a:3000;
}
```

#### ë‹¤ì–‘í•œ ì„œë¸Œ ê²½ë¡œ ë¯¸ëŸ¬ë§ ì˜ˆì œ

NGINXëŠ” ìœ ì—°í•œ ë¯¸ëŸ¬ë§ ì„¤ì •ì„ ì§€ì›í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” ë‹¤ì–‘í•œ ì¡°ê±´ê³¼ ê²½ë¡œì— ë”°ë¼ ë¯¸ëŸ¬ë§ì„ ìˆ˜í–‰í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.

##### 1. íŠ¹ì • ì„œë¸Œ ê²½ë¡œë§Œ ë¯¸ëŸ¬ë§

```nginx
server {
    listen 80;

    # /api/users/ ê²½ë¡œë§Œ ë¯¸ëŸ¬ë§
    location /api/users/ {
        mirror /mirror_users/;
        proxy_pass http://server_a:3000;
    }

    # /api/products/ ê²½ë¡œë§Œ ë¯¸ëŸ¬ë§
    location /api/products/ {
        mirror /mirror_products/;
        proxy_pass http://server_a:3000;
    }

    # ì¼ë°˜ API ê²½ë¡œ (ë¯¸ëŸ¬ë§ ì—†ìŒ)
    location /api/ {
        proxy_pass http://server_a:3000;
    }

    # users ë¯¸ëŸ¬ë§ì„ ìœ„í•œ ë‚´ë¶€ ìœ„ì¹˜
    location = /mirror_users/ {
        internal;
        proxy_pass http://server_b:3000;
    }

    # products ë¯¸ëŸ¬ë§ì„ ìœ„í•œ ë‚´ë¶€ ìœ„ì¹˜
    location = /mirror_products/ {
        internal;
        proxy_pass http://server_c:3000;  # ë‹¤ë¥¸ ì„œë²„ë¡œ ë¯¸ëŸ¬ë§
    }
}
```

##### 2. HTTP ë©”ì„œë“œì— ë”°ë¥¸ ë¯¸ëŸ¬ë§

```nginx
server {
    listen 80;

    location /api/ {
        # POST ìš”ì²­ë§Œ ë¯¸ëŸ¬ë§
        if ($request_method = "POST") {
            mirror /mirror/;
        }
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

##### 3. ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì— ë”°ë¥¸ ë¯¸ëŸ¬ë§

```nginx
server {
    listen 80;

    location /api/ {
        # debug=true ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œë§Œ ë¯¸ëŸ¬ë§
        if ($arg_debug = "true") {
            mirror /mirror/;
        }
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

##### 4. íŠ¹ì • í—¤ë” ê°’ì´ë‚˜ ì¿ í‚¤ì— ë”°ë¥¸ ë¯¸ëŸ¬ë§

```nginx
server {
    listen 80;

    location /api/ {
        # íŠ¹ì • ì‚¬ìš©ì ì—ì´ì „íŠ¸ë§Œ ë¯¸ëŸ¬ë§
        if ($http_user_agent ~* "PostmanRuntime") {
            mirror /mirror/;
        }
        # íŠ¹ì • ì„¸ì…˜ IDë¥¼ ê°€ì§„ ìš”ì²­ë§Œ ë¯¸ëŸ¬ë§
        if ($cookie_sessionid = "test-session") {
            mirror /mirror/;
        }
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

##### 5. ìš”ì²­ ë³¸ë¬¸ ë³€ê²½í•˜ì—¬ ë¯¸ëŸ¬ë§ (ì£¼ì˜: ì‹¤í—˜ì  ê¸°ëŠ¥)

```nginx
server {
    listen 80;

    location /api/ {
        mirror /mirror/;
        proxy_pass http://server_a:3000;
    }

    location = /mirror/ {
        internal;
        
        # ë¯¸ëŸ¬ë§ëœ ìš”ì²­ì— ì¶”ê°€ í—¤ë” ì „ë‹¬
        proxy_set_header X-Mirrored-Request "true";
        
        # ìš”ì²­ ë³¸ë¬¸ì„ ê·¸ëŒ€ë¡œ ì „ë‹¬
        proxy_pass_request_body on;
        
        # ì›ë³¸ HTTP ë©”ì„œë“œ ìœ ì§€
        proxy_method $request_method;
        
        proxy_pass http://server_b:3000;
    }
}
```

##### 6. íŠ¸ë˜í”½ ìƒ˜í”Œë§ (ì¼ë¶€ ìš”ì²­ë§Œ ë¯¸ëŸ¬ë§)

```nginx
server {
    listen 80;
    
    # ë³€ìˆ˜ ì„¤ì •
    set $do_mirror 0;
    
    # ì•½ 10%ì˜ ìš”ì²­ë§Œ ë¯¸ëŸ¬ë§ (ì„ì˜ ìƒ˜í”Œë§)
    if ($request_id ~ "^.{0}[0-9a].*$") {
        set $do_mirror 1;
    }
    
    location /api/ {
        if ($do_mirror = 1) {
            mirror /mirror/;
        }
        proxy_pass http://server_a:3000;
    }
    
    location = /mirror/ {
        internal;
        proxy_pass http://server_b:3000;
    }
}
```

ì´ëŸ¬í•œ ê³ ê¸‰ ì„¤ì •ì„ í†µí•´ ë¯¸ëŸ¬ë§ì„ íŠ¹ì • í™˜ê²½ì´ë‚˜ ìš”êµ¬ì‚¬í•­ì— ë§ê²Œ ì„¸ë°€í•˜ê²Œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì„±ëŠ¥ ì˜í–¥ì„ ê³ ë ¤í•˜ì—¬ ì ì ˆí•œ ë¯¸ëŸ¬ë§ ì „ëµì„ ì„ íƒí•˜ì„¸ìš”.

### 3. ëª¨ë‹ˆí„°ë§ ì¶”ê°€

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

- Docker ë„¤íŠ¸ì›Œí¬ ë‚´ì—ì„œ ì„œë¹„ìŠ¤ ê°„ í†µì‹  ì‹œ ì„œë¹„ìŠ¤ëª…ì„ í˜¸ìŠ¤íŠ¸ëª…ìœ¼ë¡œ ì‚¬ìš©
- `host.docker.internal`ì€ Mac/Windows í™˜ê²½ì—ì„œ í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•
- Docker ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì‹œ ì£¼ì˜ì‚¬í•­:
  - ë¡œì»¬ í´ë”ë¥¼ ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸í•˜ë©´ ì»¨í…Œì´ë„ˆ ë‚´ ê¸°ì¡´ íŒŒì¼ì´ ê°€ë ¤ì§ˆ ìˆ˜ ìˆìŒ
  - node_modules ê°™ì€ ì¤‘ìš” ë””ë ‰í† ë¦¬ëŠ” ìµëª… ë³¼ë¥¨ìœ¼ë¡œ ë³´ì¡´í•´ì•¼ í•¨

---

## ğŸ“¬ ë¬¸ì˜ ë° ì¶”ê°€ ì •ë³´

- ë” ë³µì¡í•œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì„±ì´ í•„ìš”í•˜ë©´ k6 ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™•ì¥í•˜ì„¸ìš”
- JWT ì¸ì¦, í—¤ë” ê¸°ë°˜ ë¼ìš°íŒ…, íŒŒì¼ ì—…ë¡œë“œ ë“±ì˜ ê³ ê¸‰ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- ì´ìŠˆë‚˜ ì§ˆë¬¸ì€ GitHub Issues ë˜ëŠ” ë¸”ë¡œê·¸ ëŒ“ê¸€ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”

---

## ğŸ”— ìœ ìš©í•œ ë§í¬

- [NGINX ë¯¸ëŸ¬ë§ ê³µì‹ ë¬¸ì„œ](https://nginx.org/en/docs/http/ngx_http_mirror_module.html)
- [Docker Compose ë¬¸ì„œ](https://docs.docker.com/compose/)
- [K6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ](https://k6.io/docs/)
- [Express.js ë¬¸ì„œ](https://expressjs.com/)

---

**ë¸”ë¡œê·¸ ì‘ì„±ì íŒ:** README ë‚´ìš©ì„ ë¸”ë¡œê·¸ì— ì˜®ê¸¸ ë•Œ, ë‹¤ì´ì–´ê·¸ë¨ê³¼ ì‹¤í–‰ ìŠ¤í¬ë¦°ìƒ·ì„ ì¶”ê°€í•˜ë©´ ë‚´ìš©ì„ ë” ëª…í™•í•˜ê²Œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•„ìš”í•œ ë¶€ë¶„ì— ì£¼ì„ì„ ë‹¬ì•„ ì´ˆë³´ìë„ ì´í•´í•˜ê¸° ì‰½ê²Œ ë§Œë“œì„¸ìš”.
